---
id: pag-depth-1
title: PAG深度解读（一）：编辑架构演进
---

PAG动画方案是诞生在视频编辑场景下的，动画的运行时编辑性是视频编辑场景下的一个核心需求，微视中贴纸字幕，视频模板，都依赖PAG运行时的动画编辑能力。PAG框架到目前已经迭代了3年左右，历经了3个大版本，PAG面对的视频编辑需求也在不断变复杂，这篇文章主要介绍PAG编辑架构的演进过程。

### 一、PAG 1.0 - 贴纸字幕

在PAG 1.0版本时，我们的主要需求是在视频上叠加各种带动画的贴纸字幕，并提供文本的编辑能力。文本编辑的原理就是运行时保留动画进行内容替换。想象一个滚字的动画从屏幕旁边一路滚过来，我在PAG里提供了接口可以修改文本内容，字体，颜色，字号等十几项属性，并保留预设的动画效果。

另外，我们在PAG 1.0里还设计了文件，控制器和渲染画布分离的架构，来组织大量的贴纸字幕。API层面共有三大核心对象。PAGRenderer代表控制器，跟实际动画实例的个数一一对应。PAGFile代表文件，可以把同一个动画文件设置给多个不同的PAGRenderer。PAGSurface，代表平台相关的渲染画布，PAGSurface上可以摆放多个PAGRenderer的动画实例。

这样的架构带来的好处是PAGFile和PAGSurface都可以被复用。假设你要画50个相同的星星动画到画布上，只需要占一份文件内存以及一份渲染缓存，并且第一个星星绘制过后，后面的所有绘制都能得到加速。另外，在传统的视频合成方案里，通常会单独渲染每个贴纸到独立的离屏纹理上，然后再依次将这些离屏纹理合成到视频上。当贴纸数量过多时，这里的显存占用就会成比例提升，并且需要做N次的合成绘制操作。而我们现在只需要创建一个跟视频画面一样大的PAGSurface，把所有的贴纸直接渲染到这个PAGSurface上，最后把PAGSurface跟视频画面做一次合成即可，这样无论加多少贴纸，显存占用都是稳定的，并且可以把N次的合成绘制，直接降到一次，从而提高渲染性能。


### 二、PAG 2.0 - 视频模板

到PAG 2.0时，我们的三大核心对象的架构没有明显变化，但是新增了视频模板的应用场景。整体是从文本的编辑原理受到启发：前面说运行时替换文本内容可以套用动画，那我们是不是可以对视频本身也套用各种动画，于是2.0版本引入了占位图的概念来解决视频模板的需求。核心原理就是运行时将视频逐帧替换到指定的占位图上，由PAG文件来控制视频的画面的动效和层级关系，输出完整的内容。这样我们的编辑架构也从多个PAG文件跟视频的叠加关系，转变为单个PAG文件对多个视频的嵌套关系。

设计师在制作视频模板时，只要添加一个占位图并当成视频处理就行，对它应用的任何变换和特效最终都会作用到替换后的视频上。我们可以使用单个占位图来实现简单添加效果的视频模板，也可以用两个占位图实现视频片段切换的转场特效，或者多个占位图来实现画面复制的多格视频。这样可以把模板的创意生产完全交给设计师发挥。另外，配合占位图的功能，我们在2.0还提供了图层名字和图层注释的访问接口，这样可以让业务方跟设计师自行约定数据填充的规则。例如哪个图层名字的占位图需要替换成视频，哪个占位图需要替换成用户头像。或者将其中的一段文本，自动填充时间或地理位置。图层名字和注释都不需要PAG SDK去理解，又可以给业务方提供充分的自定义扩展能力。

### 三、PAG 3.0 - 智能模板

到PAG3.0时，我们的编辑需求进入了智能模板的阶段。跟2.0的视频模板的主要区别是引入了前置位分析的过程，会根据用户传的视频内容，自动生成一个针对性的模板。2.0的视频模板更像是一个命题作文，让用户传视频填空的模式。而3.0的智能模板存在无限种可能性，设计师没法靠穷举每种可能性去生产素材。最佳方式是生产一个个小的PAG效果组件，然后进行组合。因此也对编辑性提出了新的挑战：就是要能对多个PAG文件，同时具有空间位置和时间轴的组合能力。

基于这个目标，我们在3.0引入了图层渲染树的编辑架构。素材的最小控制单元由文件变成了图层。一个文件就是一棵渲染树，内部每个图层都可以任意修改位置或者增删图层，也可以把别的文件添加到这棵渲染树里作为子树。另外还提供了视频图层接口，可以直接添加用户的视频片段到渲染树。这样在空间位置的组合上，一套API同时可以满足1.0的叠加需求以及2.0的嵌套需求。而在时间轴的组合上。PAGFile增加了时间伸缩的能力，提供循环，变速，定格等多种自适应模式，可以灵活适配用户的视频时长。每个图层又提供了起始时间的调整能力，能够自由组合每个图层在时间轴上的相对位置。

经过这些改造，新的接口不仅满足了智能模板的编辑性需求，也简化了原有业务调用的复杂度。例如原先业务上除了要构建外部的视频时间轴，还需要在渲染的过程中不断手动更新每个视频片段和PAG进度的对应关系。现在无论哪种使用场景，都可以简化为两个步骤：利用空间和时间的组合能力构建一个渲染树，然后播放或者导出即可。

经过以上三个版本的迭代，PAG目前已经能够灵满足各种编辑场景下的需求。